# main.py

import streamlit as st
import os
from PIL import Image
import pandas as pd

# Configuraci√≥n general de la p√°gina
st.set_page_config(page_title="Gebmind", page_icon="üåê", layout="wide")

# Definir rutas base de carpetas (seg√∫n tu estructura real)
ASSETS_DIR = os.path.join(os.path.dirname(__file__), "assets")
DATA_DIR = os.path.join(ASSETS_DIR, "data")
MAPS_DIR = os.path.join(ASSETS_DIR, "maps")
IMAGES_DIR = os.path.join(ASSETS_DIR, "images")
MODELS_DIR = os.path.join(ASSETS_DIR, "models")  # por si quieres usarlo m√°s adelante

# Funci√≥n para cargar im√°genes de forma segura
def load_image(image_name):
    image_path = os.path.join(ASSETS_DIR, image_name)
    if os.path.exists(image_path):
        try:
            return Image.open(image_path)
        except Exception as e:
            st.warning(f"‚ö†Ô∏è No se pudo abrir la imagen {image_name}: {e}")
    else:
        st.warning(f"‚ö†Ô∏è Imagen no encontrada: {image_name}")
    return None

# Sidebar con logo y navegaci√≥n
logo = load_image("gebmindlogo.png")
if logo:
    st.sidebar.image(logo, width=100)

st.sidebar.title("Navegaci√≥n")
opcion = st.sidebar.radio("", ("Inicio", "Base de datos", "Nuestros mapas", "Resultados del Modelo", "Contacto", "Qui√©nes Somos"))

# --- P√°gina de Inicio ---
if opcion == "Inicio":
    st.title("Bienvenido a Gebmind: Encuentra el Local Perfecto para tu Negocio")

    col1, col2 = st.columns([1, 2])
    if logo:
        st.image(logo, width=200)

    with col1:
        st.subheader("üåü Nuestro Producto")
        st.write("""
        Ofrecemos soluciones innovadoras para la transformaci√≥n digital de tu negocio.
        Nuestra plataforma usa Inteligencia Artificial para analizar datos y encontrar las mejores opciones de locales.
        """)

    with col2:
        st.subheader("üîç ¬øPor qu√© elegirnos?")
        st.write("""
        Elegir la ubicaci√≥n adecuada es clave para el √©xito de cualquier empresa.
        En Gebmind analizamos datos demogr√°ficos, socioecon√≥micos y de competencia para ayudarte a tomar la mejor decisi√≥n.
        """)

    st.subheader("üöÄ ¬øC√≥mo te ayudamos?")
    st.markdown("""
    - **An√°lisis Demogr√°fico:** Datos de poblaci√≥n y nivel socioecon√≥mico.
    - **An√°lisis de la Competencia:** Identifica negocios similares.
    - **Informaci√≥n de Locales:** Caracter√≠sticas, precios y fotos.
    """)

# --- P√°gina de Base de datos ---
elif opcion == "Base de datos":
    st.title("Explora nuestra Base de Datos de Locales")

    # Cargar la base de datos desde el CSV
    csv_path = os.path.join(DATA_DIR, "locales.csv")
    if os.path.exists(csv_path):
        df = pd.read_csv(csv_path)

        # Mostrar columnas para depuraci√≥n si lo necesitas
        # st.write("üßê Columnas disponibles:", df.columns.tolist())

        st.sidebar.subheader("Filtros de B√∫squeda")

        # Filtro por C√≥digo Postal (formato 5 d√≠gitos)
        codigo_postal = st.sidebar.text_input("C√≥digo Postal (formato 5 d√≠gitos):", "")
        if codigo_postal and not codigo_postal.isdigit():
            st.sidebar.warning("‚ö†Ô∏è El C√≥digo Postal debe ser num√©rico.")
        elif codigo_postal and len(codigo_postal) != 5:
            st.sidebar.warning("‚ö†Ô∏è El C√≥digo Postal debe tener 5 d√≠gitos.")

        # Filtro por puntuaci√≥n_media
        min_puntuacion = float(df['puntuacion_media'].min())
        max_puntuacion = float(df['puntuacion_media'].max())
        puntuacion_range = st.sidebar.slider(
            "Puntuaci√≥n:",
            min_value=min_puntuacion,
            max_value=max_puntuacion,
            value=(min_puntuacion, max_puntuacion)
        )

        # Filtro por numero_reviews
        min_reviews = int(df['numero_reviews'].min())
        max_reviews = int(df['numero_reviews'].max())
        reviews_range = st.sidebar.slider(
            "N√∫mero de reviews:",
            min_value=min_reviews,
            max_value=max_reviews,
            value=(min_reviews, max_reviews)
        )

        # Filtrar DataFrame seg√∫n criterios
        filtered_df = df.copy()

        if codigo_postal and codigo_postal.isdigit() and len(codigo_postal) == 5:
            filtered_df = filtered_df[filtered_df['codigo_postal'] == int(codigo_postal)]

        filtered_df = filtered_df[
            (filtered_df['puntuacion_media'] >= puntuacion_range[0]) &
            (filtered_df['puntuacion_media'] <= puntuacion_range[1]) &
            (filtered_df['numero_reviews'] >= reviews_range[0]) &
            (filtered_df['numero_reviews'] <= reviews_range[1])
        ]

        # Mostrar resultados
        st.dataframe(filtered_df)

    else:
        st.warning("‚ö†Ô∏è No se encontr√≥ el archivo locales.csv en la carpeta de datos.")

# --- P√°gina de Nuestros mapas ---
if opcion == "Nuestros mapas":
    st.title("Nuestros Mapas de Locales Disponibles")

    # Obtener lista de mapas disponibles (HTML o PNG en la carpeta de mapas)
    mapas_disponibles = [f for f in os.listdir(MAPS_DIR) if f.endswith(('.html', '.png'))]

    if mapas_disponibles:
        # Selector lateral
        mapa_seleccionado = st.sidebar.selectbox(
            "Selecciona un mapa:", 
            mapas_disponibles
        )

        # Construir la ruta completa
        mapa_path = os.path.join(MAPS_DIR, mapa_seleccionado)

        # Mostrar el mapa (seg√∫n su extensi√≥n)
        if mapa_seleccionado.endswith('.html'):
            with open(mapa_path, 'r', encoding='utf-8') as f:
                html_content = f.read()
            st.components.v1.html(html_content, height=600, scrolling=True)
        elif mapa_seleccionado.endswith('.png'):
            st.image(mapa_path, caption=mapa_seleccionado, use_column_width=True)
        else:
            st.warning("Formato de archivo no soportado.")
    else:
        st.warning("No se encontraron mapas en la carpeta.")

# --- Resultados del Modelo ---
elif opcion == "Resultados del Modelo":
    st.title("üîé Resultados del Modelo Predictivo")

    # Mostrar reporte de clasificaci√≥n (CSV)
    report_path = os.path.join(DATA_DIR, "classification_report.csv")
    if os.path.exists(report_path):
        st.success("‚úÖ Reporte de clasificaci√≥n cargado correctamente.")
        report_df = pd.read_csv(report_path)
        st.dataframe(report_df)
    else:
        st.warning("‚ö†Ô∏è Reporte de clasificaci√≥n no disponible.")

    st.subheader("üìä Visualizaciones del Modelo")

    # Lista de im√°genes y captions
    imagenes_resultados = [
        ("curvas_roc.png", "Curvas ROC"),
        ("distribucion_clases_original.png", "Distribuci√≥n de Clases Original"),
        ("distribucion_clases_smote.png", "Distribuci√≥n de Clases Despu√©s de SMOTE"),
        ("importancia_variables.png", "Importancia de Variables"),
        ("matriz_confusion.png", "Matriz de Confusi√≥n")
    ]

    # Mostrar im√°genes en columnas con tama√±o adaptativo
    cols = st.columns(len(imagenes_resultados))
    for col, (img_name, caption) in zip(cols, imagenes_resultados):
        img_path = os.path.join(IMAGES_DIR, img_name)
        if os.path.exists(img_path):
            with open(img_path, "rb") as file:
                img_bytes = file.read()
            # Cargar imagen con resoluci√≥n original y usar el nuevo par√°metro
            col.image(img_bytes, caption=caption, use_container_width=True)
        else:
            col.warning(f"‚ö†Ô∏è Imagen no encontrada: {img_name}")

# --- P√°gina de Contacto ---
elif opcion == "Contacto":
    st.subheader("üì¨ Formulario de Contacto")
    st.markdown("¬øTienes preguntas o necesitas ayuda? ¬°Cont√°ctanos!")

    with st.form("formulario_contacto"):
        nombre = st.text_input("Nombre")
        correo = st.text_input("Correo Electr√≥nico")
        mensaje = st.text_area("Mensaje")
        enviado = st.form_submit_button("Enviar")

    if enviado:
        if nombre and correo and mensaje:
            st.success("¬°Gracias por tu mensaje! Te responderemos pronto.")
        else:
            st.warning("‚ö†Ô∏è Por favor, completa todos los campos.")

# --- P√°gina de Qui√©nes Somos ---
elif opcion == "Qui√©nes Somos":
    st.subheader("üë• Conoce a Gebmind")

    col_texto, col_imagen = st.columns([2, 1])

    with col_texto:
        st.write("""
        En Gebmind somos un equipo apasionado por la tecnolog√≠a y la Inteligencia Artificial.
        Queremos ayudarte a transformar tu negocio con an√°lisis de datos y soporte personalizado.
        """)

        st.markdown("""
        **Nuestros valores:**
        - üî¨ Innovaci√≥n constante para resolver desaf√≠os.
        - ü§ù Compromiso con nuestros clientes.
        - ü•á Excelencia en soluciones y atenci√≥n.
        """)

        st.subheader("üìå Informaci√≥n de Contacto")
        st.write("""
        - **Empresa**: GEBMIND S.L.
        - **Descripci√≥n**: Proveedor de soluciones tecnol√≥gicas y consultor√≠a.
        - **Direcci√≥n**: Madrid, Espa√±a.
        - **Correo**: gebmind@gmail.com
        - **Tel√©fono**: +34 616 391 289
        """)

        # --- Enlace a GitHub con su logo ---
        github_logo_path = os.path.join(IMAGES_DIR, "github_logo.png")  # Ajusta la ruta si tu carpeta de im√°genes es diferente
        if os.path.exists(github_logo_path):
            st.markdown(
                f'<a href="https://github.com/gebmind" target="_blank">'
                f'<img src="https://raw.githubusercontent.com/gebmind/gebmind_web/main/assets/images/github_logo.png" width="40" alt="GitHub Logo"></a>',
                unsafe_allow_html=True
            )
        else:
            st.warning("‚ö†Ô∏è Logo de GitHub no encontrado. Col√≥calo en assets/images/github_logo.png")

    with col_imagen:
        equipo_path = os.path.join(ASSETS_DIR, "gebmindteam.png")
        if os.path.exists(equipo_path):
            st.image(equipo_path, caption="Equipo Gebmind", use_container_width=True)
        else:
            st.warning("No se encontr√≥ la imagen del equipo.")

# --- Pie de P√°gina ---
st.markdown("""
---
üåê Desarrollado por Gebmind ¬© 2025  
""")